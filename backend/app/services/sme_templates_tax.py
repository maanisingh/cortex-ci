"""
SME Document Templates - Phase 11: Tax and Regulatory Documents
Russian tax filings and regulatory submissions

Document Types:
1. Tax Registration Application (Заявление о постановке на учёт)
2. Tax Deregistration Application (Заявление о снятии с учёта)
3. USN Application (Уведомление о переходе на УСН)
4. UTII Application (Заявление о применении ЕНВД)
5. Tax Payment Order (Платёжное поручение на налоги)
6. VAT Declaration Cover (Титульный лист НДС)
7. Profit Tax Declaration Cover (Титульный лист налог на прибыль)
8. USN Declaration Cover (Титульный лист УСН)
9. Property Tax Declaration Cover (Титульный лист налог на имущество)
10. 6-NDFL Report Cover (Титульный лист 6-НДФЛ)
11. RSV Report Cover (Титульный лист РСВ)
12. Tax Reconciliation Request (Запрос на сверку с ФНС)
13. Tax Deferral Application (Заявление об отсрочке уплаты налогов)
14. Tax Refund Application (Заявление на возврат налогов)
15. Tax Explanation Letter (Пояснительная записка в ФНС)
"""

from typing import Dict, Any, List, Optional
from datetime import date, datetime
from decimal import Decimal
from enum import Enum
from pydantic import BaseModel


class TaxDocType(str, Enum):
    TAX_REGISTRATION = "tax_registration"
    TAX_DEREGISTRATION = "tax_deregistration"
    USN_APPLICATION = "usn_application"
    UTII_APPLICATION = "utii_application"
    TAX_PAYMENT_ORDER = "tax_payment_order"
    VAT_DECLARATION = "vat_declaration"
    PROFIT_TAX_DECLARATION = "profit_tax_declaration"
    USN_DECLARATION = "usn_declaration"
    PROPERTY_TAX_DECLARATION = "property_tax_declaration"
    NDFL_6_REPORT = "ndfl_6_report"
    RSV_REPORT = "rsv_report"
    TAX_RECONCILIATION = "tax_reconciliation"
    TAX_DEFERRAL = "tax_deferral"
    TAX_REFUND = "tax_refund"
    TAX_EXPLANATION = "tax_explanation"


class TaxSystem(str, Enum):
    OSNO = "ОСНО"
    USN_INCOME = "УСН (доходы)"
    USN_INCOME_EXPENSE = "УСН (доходы минус расходы)"
    PATENT = "ПСН"
    ESHN = "ЕСХН"
    NPD = "НПД"


class TaxPeriod(str, Enum):
    Q1 = "1 квартал"
    Q2 = "2 квартал / полугодие"
    Q3 = "3 квартал / 9 месяцев"
    Q4 = "4 квартал / год"
    YEAR = "год"
    MONTH = "месяц"


# =============================================================================
# Template 1: Tax Registration Application
# =============================================================================

TAX_REGISTRATION_TEMPLATE = """
                                             В ИФНС России № {ifns_number}
                                             по {ifns_location}
                                             Код налогового органа: {ifns_code}

                              ЗАЯВЛЕНИЕ
              о постановке на учёт в налоговом органе

Прошу поставить на учёт:

┌───────────────────────────────────────────────────────────────────────────────┐
│ Полное наименование организации:                                              │
│ {organization_name}                                                           │
├───────────────────────────────────────────────────────────────────────────────┤
│ ИНН: {inn}                              │ ОГРН: {ogrn}                        │
├───────────────────────────────────────────────────────────────────────────────┤
│ Адрес места нахождения:                                                       │
│ {legal_address}                                                               │
├───────────────────────────────────────────────────────────────────────────────┤
│ Основание для постановки на учёт:                                             │
│ {registration_basis}                                                          │
├───────────────────────────────────────────────────────────────────────────────┤
│ Дата возникновения основания: {basis_date}                                    │
└───────────────────────────────────────────────────────────────────────────────┘

Сведения о руководителе:
┌───────────────────────────────────────────────────────────────────────────────┐
│ ФИО: {director_name}                                                          │
│ ИНН: {director_inn}                                                           │
│ Должность: {director_position}                                                │
│ Контактный телефон: {director_phone}                                          │
└───────────────────────────────────────────────────────────────────────────────┘

Приложения:
{attachments_list}

Достоверность и полноту сведений, указанных в настоящем заявлении, подтверждаю.

{signatory_type}

{signatory_name}
ИНН (при наличии): {signatory_inn}

Подпись: ___________________                Дата: «{day}» {month} {year} г.

М.П.

Контактный телефон: {contact_phone}
E-mail: {contact_email}
"""


# =============================================================================
# Template 2: USN Application (Уведомление о переходе на УСН)
# =============================================================================

USN_APPLICATION_TEMPLATE = """
                                                        Форма № 26.2-1
                                                        Код по КНД 1150001

                                             В ИФНС России № {ifns_number}
                                             по {ifns_location}
                                             Код: {ifns_code}

                    УВЕДОМЛЕНИЕ О ПЕРЕХОДЕ НА УПРОЩЁННУЮ
                        СИСТЕМУ НАЛОГООБЛОЖЕНИЯ

┌───────────────────────────────────────────────────────────────────────────────┐
│ ИНН: {inn}                                                                    │
│ КПП: {kpp}                                                                    │
├───────────────────────────────────────────────────────────────────────────────┤
│ Признак налогоплательщика (код):  {taxpayer_code}                             │
│                                                                               │
│ 1 - подаёт уведомление одновременно с документами на регистрацию              │
│ 2 - подаёт уведомление в течение 30 дней с даты постановки на учёт            │
│ 3 - переходит на УСН с иных режимов налогообложения                           │
├───────────────────────────────────────────────────────────────────────────────┤
│ Переходит на упрощённую систему налогообложения:                              │
│                                                                               │
│ с «01» января {usn_year} года                                                 │
├───────────────────────────────────────────────────────────────────────────────┤
│ Наименование организации / ФИО индивидуального предпринимателя:               │
│ {taxpayer_name}                                                               │
├───────────────────────────────────────────────────────────────────────────────┤
│ В качестве объекта налогообложения выбраны (код):  {object_code}              │
│                                                                               │
│ 1 - доходы                                                                    │
│ 2 - доходы, уменьшенные на величину расходов                                  │
├───────────────────────────────────────────────────────────────────────────────┤
│ Год подачи уведомления о переходе на УСН: {application_year}                  │
├───────────────────────────────────────────────────────────────────────────────┤
│ Получено доходов за девять месяцев года подачи уведомления:                   │
│ {nine_months_income} тыс. рублей                                              │
├───────────────────────────────────────────────────────────────────────────────┤
│ Остаточная стоимость основных средств на 1 октября года подачи:               │
│ {fixed_assets_value} тыс. рублей                                              │
├───────────────────────────────────────────────────────────────────────────────┤
│ Средняя численность работников: {employee_count} человек                      │
└───────────────────────────────────────────────────────────────────────────────┘

Данное уведомление составлено на {pages_count} странице(ах)
с приложением подтверждающих документов или их копий на {attachments_count} листах.

┌──────────────────────────────────────────┬────────────────────────────────────┐
│ Достоверность и полноту сведений,        │ Заполняется работником             │
│ указанных в настоящем уведомлении,       │ налогового органа                  │
│ подтверждаю:                             │                                    │
│                                          │ Данное уведомление представлено    │
│ 1 - налогоплательщик                     │ (код): ___                         │
│ 2 - представитель налогоплательщика      │                                    │
│                                          │ на ___ страницах                   │
│ {signatory_name}                         │ с приложением на ___ листах        │
│ ___________________                      │                                    │
│      (подпись)                           │ Дата представления: ____________   │
│                                          │                                    │
│ Дата: «{day}» {month} {year} г.          │ Зарегистрировано за № ___________  │
│                                          │                                    │
│ Документ, подтверждающий полномочия:     │ ________________________           │
│ {authorization_doc}                      │ (ФИО работника налогового органа)  │
│                                          │                                    │
│ Контактный телефон: {contact_phone}      │ ________________________           │
│                                          │           (подпись)                │
│ М.П.                                     │                                    │
└──────────────────────────────────────────┴────────────────────────────────────┘
"""


# =============================================================================
# Template 3: Tax Payment Order (Платёжное поручение на налоги)
# =============================================================================

TAX_PAYMENT_ORDER_TEMPLATE = """
                                                    Поступ. в банк плат.
                                                    ____________________
                                              0401060
                              ПЛАТЁЖНОЕ ПОРУЧЕНИЕ № {payment_number}

{payment_date}                                              {payment_type}

Сумма      │ {amount_words}
прописью   │
───────────┴───────────────────────────────────────────────────────────────────
ИНН {payer_inn}          │ КПП {payer_kpp}                   │Сумма │{amount}   │
──────────────────────────────────────────────────────────────┤      │          │
{payer_name}                                                  │      │          │
                                                              ├──────┼──────────┤
                                                              │Сч. № │{payer_acc}│
Плательщик                                                    │      │          │
──────────────────────────────────────────────────────────────┼──────┼──────────┤
{payer_bank}                                                  │БИК   │{payer_bik}│
                                                              ├──────┼──────────┤
                                                              │Сч. № │{payer_corr}│
Банк плательщика                                              │      │          │
──────────────────────────────────────────────────────────────┼──────┼──────────┤
{recipient_bank}                                              │БИК   │{recipient_bik}│
                                                              ├──────┼──────────┤
                                                              │Сч. № │{recipient_corr}│
Банк получателя                                               │      │          │
──────────────────────────────────────────────────────────────┼──────┼──────────┤
ИНН {recipient_inn}      │ КПП {recipient_kpp}               │Сч. № │{recipient_acc}│
──────────────────────────────────────────────────────────────┤      │          │
{recipient_name}                                              │      │          │
                                                              │      │          │
Получатель                                                    │      │          │
──────────────────────────────────────────────────────────────┴──────┴──────────┘
Вид оп.│{op_type}│Срок плат.│      │Наз. пл.│     │Очер.│{priority}│Код │{uip}  │
       │        │          │      │        │     │плат.│          │    │       │
───────┴────────┴──────────┴──────┴────────┴─────┴─────┴──────────┴────┴───────┘
Рез.поле │          │
─────────┴──────────┴──────────────────────────────────────────────────────────┘
{status}│{kbk}                    │{oktmo}      │{reason}│{tax_period}│{doc_number}│{doc_date}│{pay_type}│
────────┴─────────────────────────┴─────────────┴────────┴────────────┴────────────┴──────────┴──────────┘

{payment_purpose}

Назначение платежа
___________________________________________________________________________________

Подписи                                               Отметки банка

______________________                                ______________________
______________________
                                    М.П.
"""


# =============================================================================
# Template 4: VAT Declaration Cover
# =============================================================================

VAT_DECLARATION_COVER_TEMPLATE = """
                                                        Форма по КНД 1151001

                    НАЛОГОВАЯ ДЕКЛАРАЦИЯ ПО НАЛОГУ
                    НА ДОБАВЛЕННУЮ СТОИМОСТЬ

                              Титульный лист

┌───────────────────────────────────────────────────────────────────────────────┐
│ Номер корректировки: {correction_number}                                      │
│ (0 - первичная декларация, 1, 2, 3... - номер корректировки)                  │
├───────────────────────────────────────────────────────────────────────────────┤
│ Налоговый период (код): {tax_period_code}                                     │
│ (21 - I квартал, 22 - II квартал, 23 - III квартал, 24 - IV квартал)          │
├───────────────────────────────────────────────────────────────────────────────┤
│ Отчётный год: {report_year}                                                   │
├───────────────────────────────────────────────────────────────────────────────┤
│ Представляется в налоговый орган (код): {ifns_code}                           │
├───────────────────────────────────────────────────────────────────────────────┤
│ по месту нахождения (учёта) (код): {location_code}                            │
│ (214 - по месту нахождения российской организации)                            │
├───────────────────────────────────────────────────────────────────────────────┤
│ Налогоплательщик:                                                             │
│ {taxpayer_name}                                                               │
├───────────────────────────────────────────────────────────────────────────────┤
│ ИНН: {inn}                              │ КПП: {kpp}                          │
├───────────────────────────────────────────────────────────────────────────────┤
│ Код вида экономической деятельности по ОКВЭД2: {okved_code}                   │
├───────────────────────────────────────────────────────────────────────────────┤
│ Номер контактного телефона: {contact_phone}                                   │
├───────────────────────────────────────────────────────────────────────────────┤
│ Декларация составлена на {pages_count} страницах                              │
│ с приложением подтверждающих документов на {attachments_count} листах         │
└───────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────┬────────────────────────────────────┐
│ Достоверность и полноту сведений,        │ Заполняется работником             │
│ указанных в настоящей декларации,        │ налогового органа                  │
│ подтверждаю:                             │                                    │
│                                          │ Сведения о представлении           │
│ 1 - налогоплательщик                     │ декларации                         │
│ 2 - представитель налогоплательщика      │                                    │
│                                          │ Данная декларация представлена     │
│ Руководитель организации / ИП:           │ (код): ___                         │
│ {signatory_name}                         │                                    │
│ ___________________                      │ на ___ страницах                   │
│      (подпись)                           │ с приложением на ___ листах        │
│                                          │                                    │
│ Дата: «{day}» {month} {year} г.          │ Дата представления: ____________   │
│                                          │                                    │
│ Документ, подтверждающий полномочия      │ Зарегистрировано за № ___________  │
│ представителя:                           │                                    │
│ {authorization_doc}                      │ ________________________           │
│                                          │ (подпись работника налог. органа)  │
│ М.П.                                     │                                    │
└──────────────────────────────────────────┴────────────────────────────────────┘
"""


# =============================================================================
# Template 5: USN Declaration Cover
# =============================================================================

USN_DECLARATION_COVER_TEMPLATE = """
                                                        Форма по КНД 1152017

          НАЛОГОВАЯ ДЕКЛАРАЦИЯ ПО НАЛОГУ, УПЛАЧИВАЕМОМУ
     В СВЯЗИ С ПРИМЕНЕНИЕМ УПРОЩЁННОЙ СИСТЕМЫ НАЛОГООБЛОЖЕНИЯ

                              Титульный лист

┌───────────────────────────────────────────────────────────────────────────────┐
│ ИНН: {inn}                                                                    │
│ КПП: {kpp}                                                                    │
├───────────────────────────────────────────────────────────────────────────────┤
│ Номер корректировки: {correction_number}                                      │
├───────────────────────────────────────────────────────────────────────────────┤
│ Налоговый период (код): {tax_period_code}                                     │
│ (34 - календарный год, 50 - при реорганизации/ликвидации)                     │
├───────────────────────────────────────────────────────────────────────────────┤
│ Отчётный год: {report_year}                                                   │
├───────────────────────────────────────────────────────────────────────────────┤
│ Представляется в налоговый орган (код): {ifns_code}                           │
├───────────────────────────────────────────────────────────────────────────────┤
│ по месту нахождения (учёта) (код): {location_code}                            │
├───────────────────────────────────────────────────────────────────────────────┤
│ Налогоплательщик:                                                             │
│ {taxpayer_name}                                                               │
├───────────────────────────────────────────────────────────────────────────────┤
│ Код вида экономической деятельности по ОКВЭД2: {okved_code}                   │
├───────────────────────────────────────────────────────────────────────────────┤
│ Код формы реорганизации (ликвидации): {reorg_code}                            │
│ ИНН/КПП реорганизованной организации: {reorg_inn_kpp}                         │
├───────────────────────────────────────────────────────────────────────────────┤
│ Номер контактного телефона: {contact_phone}                                   │
├───────────────────────────────────────────────────────────────────────────────┤
│ Декларация составлена на {pages_count} страницах                              │
│ с приложением подтверждающих документов на {attachments_count} листах         │
└───────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────┬────────────────────────────────────┐
│ Достоверность и полноту сведений,        │ Заполняется работником             │
│ указанных в настоящей декларации,        │ подтверждаю:                       │
│                                          │                                    │
│ 1 - налогоплательщик                     │ Дата представления: ____________   │
│ 2 - представитель налогоплательщика      │ Зарегистрировано за № ___________  │
│                                          │                                    │
│ {signatory_name}                         │ ________________________           │
│ ___________________                      │ (подпись работника)                │
│      (подпись)                           │                                    │
│                                          │                                    │
│ Дата: «{day}» {month} {year} г.          │                                    │
│                                          │                                    │
│ М.П.                                     │                                    │
└──────────────────────────────────────────┴────────────────────────────────────┘
"""


# =============================================================================
# Template 6: 6-NDFL Report Cover
# =============================================================================

NDFL_6_COVER_TEMPLATE = """
                                                        Форма по КНД 1151099

        РАСЧЁТ СУММ НАЛОГА НА ДОХОДЫ ФИЗИЧЕСКИХ ЛИЦ,
        ИСЧИСЛЕННЫХ И УДЕРЖАННЫХ НАЛОГОВЫМ АГЕНТОМ
                              (ФОРМА 6-НДФЛ)

                              Титульный лист

┌───────────────────────────────────────────────────────────────────────────────┐
│ ИНН: {inn}                              │ КПП: {kpp}                          │
├───────────────────────────────────────────────────────────────────────────────┤
│ Номер корректировки: {correction_number}                                      │
├───────────────────────────────────────────────────────────────────────────────┤
│ Период представления (код): {period_code}                                     │
│ (21 - 1 квартал, 31 - полугодие, 33 - 9 месяцев, 34 - год)                    │
├───────────────────────────────────────────────────────────────────────────────┤
│ Отчётный год: {report_year}                                                   │
├───────────────────────────────────────────────────────────────────────────────┤
│ Представляется в налоговый орган (код): {ifns_code}                           │
├───────────────────────────────────────────────────────────────────────────────┤
│ по месту нахождения (учёта) (код): {location_code}                            │
├───────────────────────────────────────────────────────────────────────────────┤
│ Налоговый агент:                                                              │
│ {agent_name}                                                                  │
├───────────────────────────────────────────────────────────────────────────────┤
│ Код по ОКТМО: {oktmo}                                                         │
├───────────────────────────────────────────────────────────────────────────────┤
│ Номер контактного телефона: {contact_phone}                                   │
├───────────────────────────────────────────────────────────────────────────────┤
│ Расчёт составлен на {pages_count} страницах                                   │
│ с приложением подтверждающих документов на {attachments_count} листах         │
└───────────────────────────────────────────────────────────────────────────────┘

Достоверность и полноту сведений подтверждаю:

1 - налоговый агент
2 - представитель налогового агента

{signatory_name}

Подпись: ___________________                Дата: «{day}» {month} {year} г.

М.П.
"""


# =============================================================================
# Template 7: RSV Report Cover (Расчёт по страховым взносам)
# =============================================================================

RSV_COVER_TEMPLATE = """
                                                        Форма по КНД 1151111

                    РАСЧЁТ ПО СТРАХОВЫМ ВЗНОСАМ

                              Титульный лист

┌───────────────────────────────────────────────────────────────────────────────┐
│ ИНН: {inn}                              │ КПП: {kpp}                          │
├───────────────────────────────────────────────────────────────────────────────┤
│ Номер корректировки: {correction_number}                                      │
├───────────────────────────────────────────────────────────────────────────────┤
│ Расчётный (отчётный) период (код): {period_code}                              │
│ (21 - 1 квартал, 31 - полугодие, 33 - 9 месяцев, 34 - год)                    │
├───────────────────────────────────────────────────────────────────────────────┤
│ Календарный год: {calendar_year}                                              │
├───────────────────────────────────────────────────────────────────────────────┤
│ Представляется в налоговый орган (код): {ifns_code}                           │
├───────────────────────────────────────────────────────────────────────────────┤
│ по месту нахождения (учёта) (код): {location_code}                            │
├───────────────────────────────────────────────────────────────────────────────┤
│ Плательщик страховых взносов:                                                 │
│ {payer_name}                                                                  │
├───────────────────────────────────────────────────────────────────────────────┤
│ Код вида экономической деятельности по ОКВЭД2: {okved_code}                   │
├───────────────────────────────────────────────────────────────────────────────┤
│ Среднесписочная численность (чел.): {avg_headcount}                           │
├───────────────────────────────────────────────────────────────────────────────┤
│ Номер контактного телефона: {contact_phone}                                   │
├───────────────────────────────────────────────────────────────────────────────┤
│ Расчёт составлен на {pages_count} страницах                                   │
│ с приложением подтверждающих документов на {attachments_count} листах         │
└───────────────────────────────────────────────────────────────────────────────┘

Достоверность и полноту сведений подтверждаю:

{signatory_name}

Подпись: ___________________                Дата: «{day}» {month} {year} г.

М.П.
"""


# =============================================================================
# Template 8: Tax Reconciliation Request
# =============================================================================

TAX_RECONCILIATION_REQUEST_TEMPLATE = """
                                             В ИФНС России № {ifns_number}
                                             по {ifns_location}
                                             Код: {ifns_code}

                              ЗАЯВЛЕНИЕ
              о проведении совместной сверки расчётов
                 по налогам, сборам и страховым взносам

От: {taxpayer_name}
ИНН: {inn}  КПП: {kpp}
Адрес: {address}
Контактный телефон: {contact_phone}
E-mail: {contact_email}

Прошу провести совместную сверку расчётов с бюджетом:

┌───────────────────────────────────────────────────────────────────────────────┐
│ Период сверки: с {period_start} по {period_end}                               │
├───────────────────────────────────────────────────────────────────────────────┤
│ Налоги и сборы для сверки:                                                    │
│                                                                               │
│ [ ] Все налоги и сборы                                                        │
│ [ ] Отдельные налоги:                                                         │
│     {selected_taxes}                                                          │
├───────────────────────────────────────────────────────────────────────────────┤
│ КБК (при необходимости): {kbk_list}                                           │
├───────────────────────────────────────────────────────────────────────────────┤
│ ОКТМО: {oktmo}                                                                │
└───────────────────────────────────────────────────────────────────────────────┘

Прошу направить акт сверки:
[ ] На бумажном носителе по адресу: {mailing_address}
[ ] В электронном виде через ТКС
[ ] В личный кабинет налогоплательщика

Руководитель организации: _____________________ / {director_name} /

М.П.

Дата: «{day}» {month} {year} г.
"""


# =============================================================================
# Template 9: Tax Deferral Application
# =============================================================================

TAX_DEFERRAL_APPLICATION_TEMPLATE = """
                                             В ИФНС России № {ifns_number}
                                             по {ifns_location}
                                             Код: {ifns_code}

                              ЗАЯВЛЕНИЕ
         о предоставлении отсрочки (рассрочки) по уплате налога

От: {taxpayer_name}
ИНН: {inn}  КПП: {kpp}
ОГРН: {ogrn}
Адрес: {address}
Контактный телефон: {contact_phone}

Прошу предоставить {deferral_type} по уплате:

┌───────────────────────────────────────────────────────────────────────────────┐
│ Вид налога (сбора): {tax_type}                                                │
│ КБК: {kbk}                                                                    │
│ Сумма к уплате: {tax_amount} рублей                                           │
│ Срок уплаты: {due_date}                                                       │
├───────────────────────────────────────────────────────────────────────────────┤
│ Запрашиваемый срок отсрочки (рассрочки): {requested_period}                   │
│ до «{deferral_end_date}»                                                      │
├───────────────────────────────────────────────────────────────────────────────┤
│ Основание для предоставления (п. 2 ст. 64 НК РФ):                             │
│                                                                               │
│ {deferral_grounds}                                                            │
├───────────────────────────────────────────────────────────────────────────────┤
│ Обязуюсь уплатить сумму налога в следующем порядке:                           │
│                                                                               │
│ {payment_schedule}                                                            │
└───────────────────────────────────────────────────────────────────────────────┘

Приложения:
{attachments_list}

Достоверность представленных сведений подтверждаю.

Руководитель: _____________________ / {director_name} /

Главный бухгалтер: _____________________ / {accountant_name} /

М.П.

Дата: «{day}» {month} {year} г.
"""


# =============================================================================
# Template 10: Tax Refund Application
# =============================================================================

TAX_REFUND_APPLICATION_TEMPLATE = """
                                                        Форма по КНД 1150058

                                             В ИФНС России № {ifns_number}
                                             Код: {ifns_code}

                              ЗАЯВЛЕНИЕ
                         о возврате суммы
           излишне уплаченного (взысканного, подлежащего
                возмещению) налога (сбора, страховых взносов,
                        пеней, штрафа)

┌───────────────────────────────────────────────────────────────────────────────┐
│ ИНН: {inn}                              │ КПП: {kpp}                          │
├───────────────────────────────────────────────────────────────────────────────┤
│ Наименование организации / ФИО ИП:                                            │
│ {taxpayer_name}                                                               │
├───────────────────────────────────────────────────────────────────────────────┤
│ На основании статьи {legal_basis} Налогового кодекса РФ прошу                 │
│ возвратить излишне {refund_type} сумму:                                       │
│                                                                               │
│ Вид платежа (код): {payment_type_code}                                        │
│ (1 - налог, 2 - сбор, 3 - страховые взносы, 4 - пени, 5 - штраф)              │
│                                                                               │
│ Наименование налога (сбора): {tax_name}                                       │
│ КБК: {kbk}                                                                    │
│ ОКТМО: {oktmo}                                                                │
├───────────────────────────────────────────────────────────────────────────────┤
│ Сумма к возврату: {refund_amount} ({refund_amount_words}) рублей              │
├───────────────────────────────────────────────────────────────────────────────┤
│ Банковские реквизиты для возврата:                                            │
│                                                                               │
│ Наименование банка: {bank_name}                                               │
│ БИК: {bank_bik}                                                               │
│ Корр. счёт: {corr_account}                                                    │
│ Расчётный счёт: {account_number}                                              │
│ Получатель: {account_holder}                                                  │
└───────────────────────────────────────────────────────────────────────────────┘

Достоверность и полноту сведений подтверждаю.

1 - налогоплательщик
2 - представитель налогоплательщика

{signatory_name}

Подпись: ___________________                Дата: «{day}» {month} {year} г.

Документ, подтверждающий полномочия: {authorization_doc}

Контактный телефон: {contact_phone}

М.П.
"""


# =============================================================================
# Template 11: Tax Explanation Letter
# =============================================================================

TAX_EXPLANATION_LETTER_TEMPLATE = """
                                             В ИФНС России № {ifns_number}
                                             по {ifns_location}
                                             Код: {ifns_code}

                         ПОЯСНИТЕЛЬНАЯ ЗАПИСКА

От: {taxpayer_name}
ИНН: {inn}  КПП: {kpp}
Адрес: {address}
Контактный телефон: {contact_phone}

На требование № {requirement_number} от {requirement_date}
о представлении пояснений

Уважаемые сотрудники налогового органа!

В ответ на Ваше требование сообщаем следующее:

{explanation_subject}

1. ОПИСАНИЕ СИТУАЦИИ:
{situation_description}

2. ПОЯСНЕНИЯ:
{detailed_explanation}

3. ВЫВОДЫ:
{conclusions}

4. ПРИЛОЖЕНИЯ (документы, подтверждающие представленные пояснения):
{attachments_list}

Считаем, что представленные пояснения являются полными и достаточными
для снятия возникших вопросов.

В случае необходимости представления дополнительных документов
или пояснений просим сообщить.

С уважением,

Руководитель: _____________________ / {director_name} /

Главный бухгалтер: _____________________ / {accountant_name} /

Исполнитель: {executor_name}, тел.: {executor_phone}

М.П.

Дата: «{day}» {month} {year} г.
"""


# =============================================================================
# Remaining Tax Templates (Shorter versions)
# =============================================================================

TAX_DEREGISTRATION_TEMPLATE = """
                                             В ИФНС России № {ifns_number}
                                             Код: {ifns_code}

                              ЗАЯВЛЕНИЕ
               о снятии с учёта в налоговом органе

{taxpayer_name}
ИНН: {inn}  КПП: {kpp}

Прошу снять с учёта в связи с: {deregistration_reason}

Дата возникновения основания: {basis_date}

Приложения: {attachments_list}

Руководитель: _____________________ / {director_name} /

Дата: «{day}» {month} {year} г.
М.П.
"""


PROFIT_TAX_DECLARATION_COVER_TEMPLATE = """
                                                        Форма по КНД 1151006

          НАЛОГОВАЯ ДЕКЛАРАЦИЯ ПО НАЛОГУ НА ПРИБЫЛЬ ОРГАНИЗАЦИЙ

┌───────────────────────────────────────────────────────────────────────────────┐
│ ИНН: {inn}                              │ КПП: {kpp}                          │
├───────────────────────────────────────────────────────────────────────────────┤
│ Номер корректировки: {correction_number}                                      │
│ Налоговый (отчётный) период (код): {tax_period_code}                          │
│ Отчётный год: {report_year}                                                   │
├───────────────────────────────────────────────────────────────────────────────┤
│ Представляется в налоговый орган (код): {ifns_code}                           │
│ Налогоплательщик: {taxpayer_name}                                             │
│ ОКВЭД2: {okved_code}                                                          │
├───────────────────────────────────────────────────────────────────────────────┤
│ Декларация на {pages_count} страницах                                         │
└───────────────────────────────────────────────────────────────────────────────┘

{signatory_name}
Дата: «{day}» {month} {year} г.    М.П.
"""


PROPERTY_TAX_DECLARATION_COVER_TEMPLATE = """
                                                        Форма по КНД 1152026

     НАЛОГОВАЯ ДЕКЛАРАЦИЯ ПО НАЛОГУ НА ИМУЩЕСТВО ОРГАНИЗАЦИЙ

┌───────────────────────────────────────────────────────────────────────────────┐
│ ИНН: {inn}                              │ КПП: {kpp}                          │
├───────────────────────────────────────────────────────────────────────────────┤
│ Номер корректировки: {correction_number}                                      │
│ Налоговый период (код): {tax_period_code}                                     │
│ Отчётный год: {report_year}                                                   │
├───────────────────────────────────────────────────────────────────────────────┤
│ Представляется в налоговый орган (код): {ifns_code}                           │
│ Налогоплательщик: {taxpayer_name}                                             │
├───────────────────────────────────────────────────────────────────────────────┤
│ ОКВЭД2: {okved_code}                                                          │
│ Номер телефона: {contact_phone}                                               │
├───────────────────────────────────────────────────────────────────────────────┤
│ Декларация на {pages_count} страницах                                         │
└───────────────────────────────────────────────────────────────────────────────┘

{signatory_name}
Дата: «{day}» {month} {year} г.    М.П.
"""


# =============================================================================
# Tax Template Service
# =============================================================================

class TaxTemplateService:
    """Service for generating tax and regulatory documents."""

    TEMPLATES = {
        TaxDocType.TAX_REGISTRATION: TAX_REGISTRATION_TEMPLATE,
        TaxDocType.TAX_DEREGISTRATION: TAX_DEREGISTRATION_TEMPLATE,
        TaxDocType.USN_APPLICATION: USN_APPLICATION_TEMPLATE,
        TaxDocType.TAX_PAYMENT_ORDER: TAX_PAYMENT_ORDER_TEMPLATE,
        TaxDocType.VAT_DECLARATION: VAT_DECLARATION_COVER_TEMPLATE,
        TaxDocType.PROFIT_TAX_DECLARATION: PROFIT_TAX_DECLARATION_COVER_TEMPLATE,
        TaxDocType.USN_DECLARATION: USN_DECLARATION_COVER_TEMPLATE,
        TaxDocType.PROPERTY_TAX_DECLARATION: PROPERTY_TAX_DECLARATION_COVER_TEMPLATE,
        TaxDocType.NDFL_6_REPORT: NDFL_6_COVER_TEMPLATE,
        TaxDocType.RSV_REPORT: RSV_COVER_TEMPLATE,
        TaxDocType.TAX_RECONCILIATION: TAX_RECONCILIATION_REQUEST_TEMPLATE,
        TaxDocType.TAX_DEFERRAL: TAX_DEFERRAL_APPLICATION_TEMPLATE,
        TaxDocType.TAX_REFUND: TAX_REFUND_APPLICATION_TEMPLATE,
        TaxDocType.TAX_EXPLANATION: TAX_EXPLANATION_LETTER_TEMPLATE,
    }

    TEMPLATE_NAMES = {
        TaxDocType.TAX_REGISTRATION: "Заявление о постановке на налоговый учёт",
        TaxDocType.TAX_DEREGISTRATION: "Заявление о снятии с налогового учёта",
        TaxDocType.USN_APPLICATION: "Уведомление о переходе на УСН",
        TaxDocType.TAX_PAYMENT_ORDER: "Платёжное поручение на уплату налогов",
        TaxDocType.VAT_DECLARATION: "Декларация по НДС (титульный лист)",
        TaxDocType.PROFIT_TAX_DECLARATION: "Декларация по налогу на прибыль",
        TaxDocType.USN_DECLARATION: "Декларация по УСН",
        TaxDocType.PROPERTY_TAX_DECLARATION: "Декларация по налогу на имущество",
        TaxDocType.NDFL_6_REPORT: "Расчёт 6-НДФЛ",
        TaxDocType.RSV_REPORT: "Расчёт по страховым взносам (РСВ)",
        TaxDocType.TAX_RECONCILIATION: "Запрос на сверку с налоговой",
        TaxDocType.TAX_DEFERRAL: "Заявление об отсрочке уплаты налогов",
        TaxDocType.TAX_REFUND: "Заявление на возврат налогов",
        TaxDocType.TAX_EXPLANATION: "Пояснительная записка в налоговую",
    }

    @classmethod
    def get_template(cls, doc_type: TaxDocType) -> str:
        return cls.TEMPLATES.get(doc_type, "")

    @classmethod
    def get_template_name(cls, doc_type: TaxDocType) -> str:
        return cls.TEMPLATE_NAMES.get(doc_type, "")

    @classmethod
    def list_templates(cls) -> List[Dict[str, str]]:
        return [
            {"type": dt.value, "name": cls.TEMPLATE_NAMES[dt]}
            for dt in TaxDocType
        ]

    @classmethod
    def generate_document(cls, doc_type: TaxDocType, data: Dict[str, Any]) -> str:
        template = cls.get_template(doc_type)
        if not template:
            raise ValueError(f"Unknown document type: {doc_type}")

        if "day" not in data:
            today = date.today()
            data["day"] = str(today.day).zfill(2)
            data["month"] = cls._get_russian_month(today.month)
            data["year"] = str(today.year)

        try:
            return template.format(**data)
        except KeyError as e:
            raise ValueError(f"Missing required field: {e}")

    @staticmethod
    def _get_russian_month(month: int) -> str:
        months = {
            1: "января", 2: "февраля", 3: "марта", 4: "апреля",
            5: "мая", 6: "июня", 7: "июля", 8: "августа",
            9: "сентября", 10: "октября", 11: "ноября", 12: "декабря"
        }
        return months.get(month, "")
